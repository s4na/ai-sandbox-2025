<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êû∂Á©∫„ÅÆÁîªÂÉè„Éà„É™„Éü„É≥„Ç∞„ÉÑ„Éº„É´ - 10MBÊúÄÈÅ©Âåñ„Éì„É•„Éº„ÉØ„Éº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 1200px;
            width: 100%;
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
            margin-bottom: 30px;
        }
        
        .drop-zone.dragover {
            background: #e8ebff;
            border-color: #764ba2;
            transform: scale(1.02);
        }
        
        .drop-zone.hidden {
            display: none;
        }
        
        .drop-icon {
            font-size: 60px;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .drop-text {
            color: #666;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .drop-subtext {
            color: #999;
            font-size: 14px;
        }
        
        .editor-container {
            display: none;
            position: relative;
        }
        
        .editor-container.active {
            display: block;
        }
        
        .toolbar {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .canvas-container {
            position: relative;
            background: #f0f0f0;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
        }
        
        #canvas {
            max-width: 100%;
            border: 1px solid #ddd;
            cursor: crosshair;
            background: white;
        }
        
        .size-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            min-width: 200px;
        }
        
        .size-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .size-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .size-label {
            color: #aaa;
            font-size: 12px;
        }
        
        .size-value {
            font-weight: bold;
            font-size: 16px;
        }
        
        .size-progress {
            width: 100%;
            height: 4px;
            background: #444;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .size-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.3s ease;
        }
        
        .crop-overlay {
            position: absolute;
            border: 3px dashed #667eea;
            background: rgba(102, 126, 234, 0.15);
            pointer-events: none;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            animation: pulse 1s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { border-color: #667eea; }
            50% { border-color: #764ba2; }
        }
        
        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 50%;
        }
        
        .crop-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .crop-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .crop-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group label {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
        }
        
        .input-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            width: 100px;
        }
        
        .quality-slider {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .quality-slider input[type="range"] {
            flex: 1;
        }
        
        .quality-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #667eea;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .crop-mode-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .crop-mode-indicator.active {
            display: block;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .crop-instructions {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .crop-instructions.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Êû∂Á©∫„ÅÆÁîªÂÉè„Éà„É™„Éü„É≥„Ç∞„ÉÑ„Éº„É´</h1>
        <p class="subtitle">10MBÊúÄÈÅ©Âåñ„Éì„É•„Éº„ÉØ„Éº - „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅßÁ∞°Âçò„Éà„É™„Éü„É≥„Ç∞</p>
        
        <div class="drop-zone" id="dropZone">
            <div class="drop-icon">üì∏</div>
            <div class="drop-text">ÁîªÂÉè„Çí„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó</div>
            <div class="drop-subtext">„Åæ„Åü„ÅØ „ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû</div>
            <input type="file" id="fileInput" accept="image/*">
        </div>
        
        <div class="editor-container" id="editorContainer">
            <div class="toolbar">
                <button class="btn btn-primary" id="cropFreeBtn">Ëá™Áî±„Çµ„Ç§„Ç∫„Åß„Éà„É™„Éü„É≥„Ç∞</button>
                <button class="btn btn-warning" id="crop10MBBtn">10MB„Å°„Çá„ÅÜ„Å©„Å´„Éà„É™„Éü„É≥„Ç∞</button>
                <button class="btn btn-success" id="downloadBtn">„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                <button class="btn btn-secondary" id="resetBtn">„É™„Çª„ÉÉ„Éà</button>
                <button class="btn btn-secondary" id="newImageBtn">Âà•„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû</button>
                
                <div class="quality-slider">
                    <label>ÂìÅË≥™:</label>
                    <input type="range" id="qualitySlider" min="10" max="100" value="85">
                    <span class="quality-value" id="qualityValue">85</span>
                </div>
                
                <div class="input-group">
                    <label>ÂπÖ:</label>
                    <input type="number" id="widthInput" min="1">
                    <label>È´ò„Åï:</label>
                    <input type="number" id="heightInput" min="1">
                </div>
            </div>
            
            <div class="canvas-container">
                <canvas id="canvas"></canvas>
                <div class="crop-overlay" id="cropOverlay" style="display: none;">
                    <div class="crop-handle nw"></div>
                    <div class="crop-handle ne"></div>
                    <div class="crop-handle sw"></div>
                    <div class="crop-handle se"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="size-display" id="sizeDisplay" style="display: none;">
        <div class="size-info">
            <div class="size-row">
                <span class="size-label">ÁèæÂú®„ÅÆ„Çµ„Ç§„Ç∫:</span>
                <span class="size-value" id="currentSize">0 MB</span>
            </div>
            <div class="size-row">
                <span class="size-label">ÁõÆÊ®ô:</span>
                <span style="color: #28a745;">10 MB</span>
            </div>
            <div class="size-row">
                <span class="size-label">Ëß£ÂÉèÂ∫¶:</span>
                <span id="resolution">0 x 0</span>
            </div>
            <div class="size-progress">
                <div class="size-progress-bar" id="sizeProgressBar"></div>
            </div>
        </div>
    </div>
    
    <div class="crop-mode-indicator" id="cropModeIndicator">
        üéØ „Éà„É™„Éü„É≥„Ç∞„É¢„Éº„Éâ
    </div>
    
    <div class="crop-instructions" id="cropInstructions">
        üìê „Éû„Ç¶„Çπ„Åß„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁØÑÂõ≤„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
    </div>
    
    <script>
        class ImageTrimmer {
            constructor() {
                this.originalImage = null;
                this.currentImage = null;
                this.beforeCropImage = null;
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.cropArea = null;
                this.isDragging = false;
                this.isCropMode = false;
                this.isShowingOriginal = false;
                this.dragStart = null;
                this.quality = 0.85;
                
                this.initEventListeners();
            }
            
            initEventListeners() {
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');
                
                // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && files[0].type.startsWith('image/')) {
                        this.loadImage(files[0]);
                    }
                });
                
                dropZone.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.loadImage(e.target.files[0]);
                    }
                });
                
                // „Éú„Çø„É≥„Ç§„Éô„É≥„Éà
                document.getElementById('cropFreeBtn').addEventListener('click', () => {
                    this.startFreeCrop();
                });
                
                document.getElementById('crop10MBBtn').addEventListener('click', () => {
                    this.startSmartCrop10MB();
                });
                
                document.getElementById('downloadBtn').addEventListener('click', () => {
                    this.downloadImage();
                });
                
                document.getElementById('resetBtn').addEventListener('click', () => {
                    this.resetImage();
                });
                
                document.getElementById('newImageBtn').addEventListener('click', () => {
                    this.selectNewImage();
                });
                
                // ÂìÅË≥™„Çπ„É©„Ç§„ÉÄ„Éº
                const qualitySlider = document.getElementById('qualitySlider');
                qualitySlider.addEventListener('input', (e) => {
                    this.quality = e.target.value / 100;
                    document.getElementById('qualityValue').textContent = e.target.value;
                    this.updateSizeDisplay();
                });
                
                // „Çµ„Ç§„Ç∫ÂÖ•Âäõ
                document.getElementById('widthInput').addEventListener('input', () => {
                    this.resizeCanvas();
                });
                
                document.getElementById('heightInput').addEventListener('input', () => {
                    this.resizeCanvas();
                });
                
                // „Ç≠„É£„É≥„Éê„Çπ„Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà
                this.canvas.addEventListener('mousedown', (e) => this.startCrop(e));
                this.canvas.addEventListener('mousemove', (e) => this.updateCrop(e));
                this.canvas.addEventListener('mouseup', () => this.endCrop());
                this.canvas.addEventListener('mouseleave', () => this.endCrop());
            }
            
            loadImage(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.originalImage = img;
                        this.currentImage = img;
                        this.displayImage(img);
                        this.showEditor();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            displayImage(img) {
                console.log(`displayImage called - Original size: ${img.width}x${img.height}`);
                
                const maxWidth = 800;
                const maxHeight = 600;
                let displayWidth = img.width;
                let displayHeight = img.height;
                
                // Ë°®Á§∫Áî®„ÅÆ„Çµ„Ç§„Ç∫„ÇíË®àÁÆóÔºà„Ç≠„É£„É≥„Éê„Çπ„ÅØË°®Á§∫Áî®Ôºâ
                if (displayWidth > maxWidth) {
                    displayHeight = (maxWidth / displayWidth) * displayHeight;
                    displayWidth = maxWidth;
                }
                if (displayHeight > maxHeight) {
                    displayWidth = (maxHeight / displayHeight) * displayWidth;
                    displayHeight = maxHeight;
                }
                
                console.log(`Canvas display size: ${displayWidth}x${displayHeight}`);
                
                this.canvas.width = displayWidth;
                this.canvas.height = displayHeight;
                this.ctx.drawImage(img, 0, 0, displayWidth, displayHeight);
                
                // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„ÅØÂÆüÈöõ„ÅÆÁîªÂÉè„Çµ„Ç§„Ç∫„ÇíË°®Á§∫
                document.getElementById('widthInput').value = Math.round(img.width);
                document.getElementById('heightInput').value = Math.round(img.height);
                
                this.updateSizeDisplay();
            }
            
            showEditor() {
                document.getElementById('dropZone').classList.add('hidden');
                document.getElementById('editorContainer').classList.add('active');
                document.getElementById('sizeDisplay').style.display = 'block';
            }
            
            hideEditor() {
                document.getElementById('dropZone').classList.remove('hidden');
                document.getElementById('editorContainer').classList.remove('active');
                document.getElementById('sizeDisplay').style.display = 'none';
            }
            
            startFreeCrop() {
                this.cropArea = null;
                this.isCropMode = true;
                document.getElementById('cropOverlay').style.display = 'none';
                document.getElementById('cropModeIndicator').classList.add('active');
                document.getElementById('cropInstructions').classList.add('active');
                this.canvas.style.cursor = 'crosshair';
                
                // Á¢∫ÂÆö„Éú„Çø„É≥„Å®„Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÇíË°®Á§∫
                this.showCropControls();
            }
            
            startCrop(e) {
                if (!this.currentImage || !this.isCropMode) return;
                
                const rect = this.canvas.getBoundingClientRect();
                this.isDragging = true;
                this.dragStart = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                
                const overlay = document.getElementById('cropOverlay');
                overlay.style.display = 'block';
                overlay.style.left = this.dragStart.x + 'px';
                overlay.style.top = this.dragStart.y + 'px';
                overlay.style.width = '0px';
                overlay.style.height = '0px';
                
                // ÊåáÁ§∫„ÇíÊõ¥Êñ∞
                document.getElementById('cropInstructions').textContent = 'üìê ÁØÑÂõ≤„ÇíË™øÊï¥‰∏≠... „Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁØÑÂõ≤„ÇíÊåáÂÆö';
            }
            
            updateCrop(e) {
                if (!this.isDragging || !this.dragStart) return;
                
                const rect = this.canvas.getBoundingClientRect();
                const currentX = e.clientX - rect.left;
                const currentY = e.clientY - rect.top;
                
                const width = Math.abs(currentX - this.dragStart.x);
                const height = Math.abs(currentY - this.dragStart.y);
                const left = Math.min(currentX, this.dragStart.x);
                const top = Math.min(currentY, this.dragStart.y);
                
                const overlay = document.getElementById('cropOverlay');
                overlay.style.left = left + 'px';
                overlay.style.top = top + 'px';
                overlay.style.width = width + 'px';
                overlay.style.height = height + 'px';
                
                this.cropArea = { left, top, width, height };
                this.updateCropSizeDisplay();
            }
            
            endCrop() {
                this.isDragging = false;
                if (this.cropArea && this.cropArea.width > 10 && this.cropArea.height > 10) {
                    // ÁØÑÂõ≤ÈÅ∏ÊäûÂÆå‰∫Ü„ÄÅÁ¢∫ÂÆöÂæÖ„Å°
                    document.getElementById('cropInstructions').innerHTML = 
                        '‚úÖ ÁØÑÂõ≤ÈÅ∏ÊäûÂÆå‰∫ÜÔºÅ<br>„Äå„Éà„É™„Éü„É≥„Ç∞Á¢∫ÂÆö„Äç„Éú„Çø„É≥„ÅßÂÆüË°å or „Äå„Ç≠„É£„É≥„Çª„É´„Äç„Åß‰∏≠Ê≠¢';
                    this.showCropButtons();
                }
            }
            
            showCropControls() {
                // Êó¢Â≠ò„ÅÆ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
                const existingButtons = document.getElementById('cropControlButtons');
                if (existingButtons) {
                    existingButtons.remove();
                }
            }
            
            showCropButtons() {
                // Êó¢Â≠ò„ÅÆ„Éú„Çø„É≥„ÇíÂâäÈô§
                const existingButtons = document.getElementById('cropControlButtons');
                if (existingButtons) {
                    existingButtons.remove();
                }
                
                // Êñ∞„Åó„ÅÑ„Éú„Çø„É≥„Ç≥„É≥„Éà„É≠„Éº„É´„Çí‰ΩúÊàê
                const controlDiv = document.createElement('div');
                controlDiv.id = 'cropControlButtons';
                controlDiv.style.cssText = `
                    position: fixed;
                    bottom: 140px;
                    left: 50%;
                    transform: translateX(-50%);
                    display: flex;
                    gap: 15px;
                    z-index: 1001;
                `;
                
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = '‚úÇÔ∏è „Éà„É™„Éü„É≥„Ç∞Á¢∫ÂÆö';
                confirmBtn.className = 'btn btn-success';
                confirmBtn.onclick = () => this.confirmCrop();
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '‚ùå „Ç≠„É£„É≥„Çª„É´';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.onclick = () => this.cancelCrop();
                
                controlDiv.appendChild(confirmBtn);
                controlDiv.appendChild(cancelBtn);
                document.body.appendChild(controlDiv);
            }
            
            confirmCrop() {
                if (!this.cropArea) return;
                
                // ÂÖÉÁîªÂÉè„Çí‰øùÂ≠òÔºàÊØîËºÉÁî®Ôºâ
                this.beforeCropImage = this.currentImage;
                
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                const scaleX = this.currentImage.width / this.canvas.width;
                const scaleY = this.currentImage.height / this.canvas.height;
                
                tempCanvas.width = this.cropArea.width * scaleX;
                tempCanvas.height = this.cropArea.height * scaleY;
                
                tempCtx.drawImage(
                    this.currentImage,
                    this.cropArea.left * scaleX,
                    this.cropArea.top * scaleY,
                    this.cropArea.width * scaleX,
                    this.cropArea.height * scaleY,
                    0, 0,
                    tempCanvas.width,
                    tempCanvas.height
                );
                
                const img = new Image();
                img.onload = () => {
                    this.currentImage = img;
                    this.displayImage(img);
                    this.exitCropMode();
                    this.showComparisonButton();
                };
                img.src = tempCanvas.toDataURL('image/jpeg', this.quality);
            }
            
            cancelCrop() {
                this.exitCropMode();
            }
            
            exitCropMode() {
                this.isCropMode = false;
                this.cropArea = null;
                document.getElementById('cropOverlay').style.display = 'none';
                document.getElementById('cropModeIndicator').classList.remove('active');
                document.getElementById('cropInstructions').classList.remove('active');
                this.canvas.style.cursor = 'default';
                
                // „Ç≥„É≥„Éà„É≠„Éº„É´„Éú„Çø„É≥„ÇíÂâäÈô§
                const controlButtons = document.getElementById('cropControlButtons');
                if (controlButtons) {
                    controlButtons.remove();
                }
            }
            
            showComparisonButton() {
                // ÊØîËºÉ„Éú„Çø„É≥„ÇíËøΩÂä†Ôºà„Åæ„Å†Â≠òÂú®„Åó„Å™„ÅÑÂ†¥ÂêàÔºâ
                if (!document.getElementById('compareBtn')) {
                    const toolbar = document.querySelector('.toolbar');
                    const compareBtn = document.createElement('button');
                    compareBtn.id = 'compareBtn';
                    compareBtn.className = 'btn btn-primary';
                    compareBtn.textContent = 'üîÑ ÂÖÉÁîªÂÉè„Å®ÊØîËºÉ';
                    compareBtn.onclick = () => this.toggleComparison();
                    toolbar.insertBefore(compareBtn, toolbar.firstChild);
                }
            }
            
            toggleComparison() {
                if (this.beforeCropImage) {
                    if (this.isShowingOriginal) {
                        this.displayImage(this.currentImage);
                        document.getElementById('compareBtn').textContent = 'üîÑ ÂÖÉÁîªÂÉè„Å®ÊØîËºÉ';
                    } else {
                        this.displayImage(this.beforeCropImage);
                        document.getElementById('compareBtn').textContent = 'üì∏ „Éà„É™„Éü„É≥„Ç∞Âæå„ÇíË°®Á§∫';
                    }
                    this.isShowingOriginal = !this.isShowingOriginal;
                }
            }
            
            startSmartCrop10MB() {
                console.log('===== „Çπ„Éû„Éº„Éà10MB„Éà„É™„Éü„É≥„Ç∞ÈñãÂßã =====');
                
                // „Éà„É™„Éü„É≥„Ç∞„É¢„Éº„Éâ„Å´ÂÖ•„Çã
                this.is10MBMode = true;
                this.isCropMode = true;
                document.getElementById('cropModeIndicator').classList.add('active');
                document.getElementById('cropModeIndicator').innerHTML = 'üìè 9-10MB„Éà„É™„Éü„É≥„Ç∞„É¢„Éº„Éâ';
                
                // 9-10MB„ÅÆÁØÑÂõ≤„ÇíË®àÁÆó„Åó„Å¶ÂÄôË£ú„É©„Ç§„É≥„ÇíË°®Á§∫
                this.calculate10MBCropSizes();
            }
            
            async calculate10MBCropSizes() {
                console.log('9-10MB„ÅÆÁØÑÂõ≤„Åß„Éà„É™„Éü„É≥„Ç∞„Çµ„Ç§„Ç∫„ÇíË®àÁÆó‰∏≠...');
                this.showProgressIndicator('9-10MB„ÅÆÁØÑÂõ≤„ÇíË®àÁÆó‰∏≠...');
                
                const targetMin = 9 * 1024 * 1024; // 9MB
                const targetMax = 10 * 1024 * 1024; // 10MB
                
                // ÁèæÂú®„ÅÆÁîªÂÉè„ÅÆ„Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÇíÁ∂≠ÊåÅ
                const aspectRatio = this.currentImage.width / this.currentImage.height;
                
                // „Åæ„ÅöÁèæÂú®„ÅÆ„Çµ„Ç§„Ç∫„Åß„ÉÅ„Çß„ÉÉ„ÇØ
                const currentSize = await this.estimateFileSize(this.currentImage.width, this.currentImage.height);
                console.log(`ÁèæÂú®„ÅÆÁîªÂÉè„Çµ„Ç§„Ç∫: ${(currentSize / (1024 * 1024)).toFixed(2)}MB`);
                
                // ÂÄôË£ú„Å®„Å™„Çã„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
                const candidates = [];
                
                if (currentSize < targetMin) {
                    // ÁîªÂÉè„ÅåÂ∞è„Åï„Åô„Åé„ÇãÂ†¥Âêà„ÅØÊã°Â§ß„ÇÇÊ§úË®é
                    console.log('ÁîªÂÉè„ÅåÂ∞è„Åï„ÅÑ„Åü„ÇÅ„ÄÅÊã°Â§ß„ÇíÊ§úË®é„Åó„Åæ„Åô');
                    const steps = 20;
                    
                    for (let i = 0; i <= steps; i++) {
                        const scale = 1.0 + (3.0 * i / steps); // 100%„Åã„Çâ400%„Åæ„Åß
                        const width = Math.round(this.currentImage.width * scale);
                        const height = Math.round(this.currentImage.height * scale);
                        
                        this.updateProgressIndicator(`„Çµ„Ç§„Ç∫Ë®àÁÆó‰∏≠... (${i + 1}/${steps + 1})`);
                        
                        // „Çµ„Ç§„Ç∫„ÇíÊé®ÂÆöÔºàÂÆüÈöõ„ÅÆ„Ç®„É≥„Ç≥„Éº„Éâ„ÅßÔºâ
                        const estimatedSize = await this.estimateFileSize(width, height);
                        console.log(`Scale ${scale.toFixed(2)}: ${width}x${height} = ${(estimatedSize / (1024 * 1024)).toFixed(2)}MB`);
                        
                        if (estimatedSize >= targetMin && estimatedSize <= targetMax) {
                            candidates.push({
                                width: width,
                                height: height,
                                scale: scale,
                                estimatedSize: estimatedSize
                            });
                        }
                        
                        // 10MB„ÇíË∂Ö„Åà„Åü„ÇâÁµÇ‰∫Ü
                        if (estimatedSize > targetMax) break;
                    }
                } else {
                    // ÈÄöÂ∏∏„ÅÆ„Çπ„Ç±„Éº„É´ÁØÑÂõ≤„ÅßÊ§úÁ¥¢
                    const steps = 10;
                    
                    for (let i = 0; i <= steps; i++) {
                        const scale = 0.5 + (0.5 * i / steps); // 50%„Åã„Çâ100%„Åæ„Åß
                        const width = Math.round(this.currentImage.width * scale);
                        const height = Math.round(this.currentImage.height * scale);
                        
                        this.updateProgressIndicator(`„Çµ„Ç§„Ç∫Ë®àÁÆó‰∏≠... (${i + 1}/${steps + 1})`);
                        
                        // „Çµ„Ç§„Ç∫„ÇíÊé®ÂÆöÔºàÂÆüÈöõ„ÅÆ„Ç®„É≥„Ç≥„Éº„Éâ„ÅßÔºâ
                        const estimatedSize = await this.estimateFileSize(width, height);
                        
                        if (estimatedSize >= targetMin && estimatedSize <= targetMax) {
                            candidates.push({
                                width: width,
                                height: height,
                                scale: scale,
                                estimatedSize: estimatedSize
                            });
                        }
                    }
                }
                
                this.hideProgressIndicator();
                
                if (candidates.length > 0) {
                    // ÊúÄÈÅ©„Å™„Çµ„Ç§„Ç∫„ÇíÈÅ∏ÊäûÔºà10MB„Å´ÊúÄ„ÇÇËøë„ÅÑ„ÇÇ„ÅÆÔºâ
                    const optimal = candidates.reduce((prev, curr) => {
                        const prevDiff = Math.abs(10 * 1024 * 1024 - prev.estimatedSize);
                        const currDiff = Math.abs(10 * 1024 * 1024 - curr.estimatedSize);
                        return currDiff < prevDiff ? curr : prev;
                    });
                    
                    console.log(`ÊúÄÈÅ©„Å™„Çµ„Ç§„Ç∫: ${optimal.width}x${optimal.height} (Á¥Ñ${(optimal.estimatedSize / (1024 * 1024)).toFixed(2)}MB)`);
                    
                    // „Éà„É™„Éü„É≥„Ç∞Êû†„ÇíË°®Á§∫
                    this.show10MBCropBox(optimal.width, optimal.height);
                } else {
                    // ÈÅ©Âàá„Å™„Çµ„Ç§„Ç∫„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅÆÂØæÂá¶
                    if (currentSize < 1024 * 1024) { // 1MBÊú™Ê∫Ä
                        alert('ÁîªÂÉè„ÅåÂ∞è„Åï„Åô„Åé„Åæ„ÅôÔºà1MBÊú™Ê∫ÄÔºâ„ÄÇ\n9-10MB„Å´„Åô„Çã„Å´„ÅØÂìÅË≥™„Çí‰øù„Å£„Åü„Åæ„ÅæÂ§ßÂπÖ„Å™Êã°Â§ß„ÅåÂøÖË¶Å„Åß„Åô„Åå„ÄÅ\nÁîªË≥™„ÅåÂä£Âåñ„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
                    } else {
                        alert('9-10MB„ÅÆÁØÑÂõ≤„Åß„Éà„É™„Éü„É≥„Ç∞„Åß„Åç„Çã„Çµ„Ç§„Ç∫„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\nÁèæÂú®„ÅÆ„Çµ„Ç§„Ç∫: ' + (currentSize / (1024 * 1024)).toFixed(2) + 'MB');
                    }
                    this.exit10MBMode();
                }
            }
            
            async estimateFileSize(width, height) {
                // ÂÆüÈöõ„ÅÆJPEG„Ç®„É≥„Ç≥„Éº„Éâ„Åß„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = width;
                tempCanvas.height = height;
                
                // ÁèæÂú®„ÅÆÁîªÂÉè„ÇíÊåáÂÆö„Çµ„Ç§„Ç∫„ÅßÊèèÁîª
                tempCtx.drawImage(this.currentImage, 0, 0, width, height);
                
                // Blob„Çí‰ΩúÊàê„Åó„Å¶ÂÆüÈöõ„ÅÆ„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
                return new Promise((resolve) => {
                    tempCanvas.toBlob((blob) => {
                        if (blob) {
                            console.log(`Estimated size for ${width}x${height}: ${(blob.size / (1024 * 1024)).toFixed(2)}MB`);
                            resolve(blob.size);
                        } else {
                            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÁ∞°ÊòìË®àÁÆó
                            const pixels = width * height;
                            const estimatedSize = Math.round(pixels * this.quality * 0.3);
                            console.log(`Fallback estimation for ${width}x${height}: ${(estimatedSize / (1024 * 1024)).toFixed(2)}MB`);
                            resolve(estimatedSize);
                        }
                    }, 'image/jpeg', this.quality);
                });
            }
            
            show10MBCropBox(targetWidth, targetHeight) {
                // Êó¢Â≠ò„ÅÆ„Éà„É™„Éü„É≥„Ç∞Êû†„ÇíÂâäÈô§
                const existingBox = document.getElementById('smartCropBox');
                if (existingBox) {
                    existingBox.remove();
                }
                
                // „Ç≠„É£„É≥„Éê„Çπ‰∏ä„Åß„ÅÆ„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
                const scaleX = this.canvas.width / this.currentImage.width;
                const scaleY = this.canvas.height / this.currentImage.height;
                const boxWidth = targetWidth * scaleX;
                const boxHeight = targetHeight * scaleY;
                
                // „Éà„É™„Éü„É≥„Ç∞Êû†„Çí‰ΩúÊàê
                const cropBox = document.createElement('div');
                cropBox.id = 'smartCropBox';
                cropBox.style.cssText = `
                    position: absolute;
                    border: 3px solid #00ff00;
                    background: rgba(0, 255, 0, 0.1);
                    cursor: move;
                    z-index: 100;
                    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
                `;
                cropBox.style.width = boxWidth + 'px';
                cropBox.style.height = boxHeight + 'px';
                cropBox.style.left = (this.canvas.width - boxWidth) / 2 + 'px';
                cropBox.style.top = (this.canvas.height - boxHeight) / 2 + 'px';
                
                // „É™„Çµ„Ç§„Ç∫„Éè„É≥„Éâ„É´„ÇíËøΩÂä†
                const handles = ['nw', 'ne', 'sw', 'se'];
                handles.forEach(pos => {
                    const handle = document.createElement('div');
                    handle.className = `resize-handle ${pos}`;
                    handle.style.cssText = `
                        position: absolute;
                        width: 12px;
                        height: 12px;
                        background: white;
                        border: 2px solid #00ff00;
                        border-radius: 50%;
                    `;
                    
                    if (pos.includes('n')) handle.style.top = '-6px';
                    if (pos.includes('s')) handle.style.bottom = '-6px';
                    if (pos.includes('w')) handle.style.left = '-6px';
                    if (pos.includes('e')) handle.style.right = '-6px';
                    
                    handle.style.cursor = `${pos}-resize`;
                    cropBox.appendChild(handle);
                });
                
                // „Çµ„Ç§„Ç∫Ë°®Á§∫„ÇíËøΩÂä†
                const sizeLabel = document.createElement('div');
                sizeLabel.id = 'smartCropSizeLabel';
                sizeLabel.style.cssText = `
                    position: absolute;
                    bottom: -30px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 12px;
                    white-space: nowrap;
                `;
                cropBox.appendChild(sizeLabel);
                
                // „Ç≠„É£„É≥„Éê„Çπ„Ç≥„É≥„ÉÜ„Éä„Å´ËøΩÂä†
                const canvasContainer = document.querySelector('.canvas-container');
                canvasContainer.style.position = 'relative';
                canvasContainer.appendChild(cropBox);
                
                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
                this.makeSmartCropBoxDraggable(cropBox);
                this.makeSmartCropBoxResizable(cropBox);
                
                // ÂàùÊúü„Çµ„Ç§„Ç∫„ÇíË°®Á§∫
                this.updateSmartCropSize(cropBox);
                
                // Á¢∫ÂÆö„Éú„Çø„É≥„ÇíË°®Á§∫
                this.showSmartCropButtons();
            }
            
            makeSmartCropBoxDraggable(box) {
                let isDragging = false;
                let startX, startY, initialLeft, initialTop;
                
                const startDrag = (e) => {
                    if (e.target.classList.contains('resize-handle')) return;
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    initialLeft = box.offsetLeft;
                    initialTop = box.offsetTop;
                    e.preventDefault();
                };
                
                const drag = (e) => {
                    if (!isDragging) return;
                    
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    
                    let newLeft = initialLeft + dx;
                    let newTop = initialTop + dy;
                    
                    // Â¢ÉÁïå„ÉÅ„Çß„ÉÉ„ÇØ
                    newLeft = Math.max(0, Math.min(newLeft, this.canvas.width - box.offsetWidth));
                    newTop = Math.max(0, Math.min(newTop, this.canvas.height - box.offsetHeight));
                    
                    box.style.left = newLeft + 'px';
                    box.style.top = newTop + 'px';
                    
                    this.updateSmartCropSize(box);
                };
                
                const endDrag = () => {
                    isDragging = false;
                };
                
                box.addEventListener('mousedown', startDrag);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', endDrag);
            }
            
            makeSmartCropBoxResizable(box) {
                const handles = box.querySelectorAll('.resize-handle');
                
                handles.forEach(handle => {
                    let isResizing = false;
                    let startX, startY, startWidth, startHeight, startLeft, startTop;
                    const pos = handle.className.split(' ')[1];
                    
                    handle.addEventListener('mousedown', (e) => {
                        isResizing = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startWidth = box.offsetWidth;
                        startHeight = box.offsetHeight;
                        startLeft = box.offsetLeft;
                        startTop = box.offsetTop;
                        e.stopPropagation();
                        e.preventDefault();
                    });
                    
                    document.addEventListener('mousemove', (e) => {
                        if (!isResizing) return;
                        
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        
                        let newWidth = startWidth;
                        let newHeight = startHeight;
                        let newLeft = startLeft;
                        let newTop = startTop;
                        
                        // „Ç¢„Çπ„Éö„ÇØ„ÉàÊØî„ÇíÁ∂≠ÊåÅ
                        const aspectRatio = this.currentImage.width / this.currentImage.height;
                        
                        if (pos.includes('e')) {
                            newWidth = startWidth + dx;
                            newHeight = newWidth / aspectRatio;
                        }
                        if (pos.includes('w')) {
                            newWidth = startWidth - dx;
                            newHeight = newWidth / aspectRatio;
                            newLeft = startLeft + dx;
                            newTop = startTop + (startHeight - newHeight);
                        }
                        if (pos.includes('s')) {
                            newHeight = startHeight + dy;
                            newWidth = newHeight * aspectRatio;
                        }
                        if (pos.includes('n')) {
                            newHeight = startHeight - dy;
                            newWidth = newHeight * aspectRatio;
                            newTop = startTop + dy;
                            newLeft = startLeft + (startWidth - newWidth);
                        }
                        
                        // ÊúÄÂ∞è„Çµ„Ç§„Ç∫Âà∂Èôê
                        if (newWidth > 50 && newHeight > 50) {
                            box.style.width = newWidth + 'px';
                            box.style.height = newHeight + 'px';
                            box.style.left = newLeft + 'px';
                            box.style.top = newTop + 'px';
                            
                            this.updateSmartCropSize(box);
                        }
                    });
                    
                    document.addEventListener('mouseup', () => {
                        isResizing = false;
                    });
                });
            }
            
            async updateSmartCropSize(box) {
                // „Ç≠„É£„É≥„Éê„ÇπÂ∫ßÊ®ô„Åã„ÇâÂÆüÈöõ„ÅÆÁîªÂÉèÂ∫ßÊ®ô„Å´Â§âÊèõ
                const scaleX = this.currentImage.width / this.canvas.width;
                const scaleY = this.currentImage.height / this.canvas.height;
                
                const actualWidth = Math.round(box.offsetWidth * scaleX);
                const actualHeight = Math.round(box.offsetHeight * scaleY);
                
                // „É©„Éô„É´„Çí‰∏ÄÊôÇÁöÑ„Å´Êõ¥Êñ∞
                const label = box.querySelector('#smartCropSizeLabel');
                if (label) {
                    label.textContent = `${actualWidth}√ó${actualHeight} (Ë®àÁÆó‰∏≠...)`;
                }
                
                // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÇíÊé®ÂÆöÔºàÈùûÂêåÊúüÔºâ
                const estimatedSize = await this.estimateFileSize(actualWidth, actualHeight);
                const sizeInMB = (estimatedSize / (1024 * 1024)).toFixed(2);
                
                // „É©„Éô„É´„ÇíÊõ¥Êñ∞
                if (label) {
                    label.textContent = `${actualWidth}√ó${actualHeight} (Á¥Ñ${sizeInMB}MB)`;
                    
                    // „Çµ„Ç§„Ç∫„Å´Âøú„Åò„Å¶Ëâ≤„ÇíÂ§âÊõ¥
                    if (estimatedSize >= 9 * 1024 * 1024 && estimatedSize <= 10 * 1024 * 1024) {
                        box.style.borderColor = '#00ff00';
                        label.style.background = 'rgba(0, 255, 0, 0.8)';
                    } else if (estimatedSize < 9 * 1024 * 1024) {
                        box.style.borderColor = '#ffff00';
                        label.style.background = 'rgba(255, 255, 0, 0.8)';
                    } else {
                        box.style.borderColor = '#ff0000';
                        label.style.background = 'rgba(255, 0, 0, 0.8)';
                    }
                }
                
                // ÁèæÂú®„ÅÆË®≠ÂÆö„Çí‰øùÂ≠ò
                this.smartCropArea = {
                    left: box.offsetLeft,
                    top: box.offsetTop,
                    width: box.offsetWidth,
                    height: box.offsetHeight,
                    actualWidth: actualWidth,
                    actualHeight: actualHeight,
                    estimatedSize: estimatedSize
                };
            }
            
            showSmartCropButtons() {
                // Êó¢Â≠ò„ÅÆ„Éú„Çø„É≥„ÇíÂâäÈô§
                const existingButtons = document.getElementById('smartCropButtons');
                if (existingButtons) {
                    existingButtons.remove();
                }
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.id = 'smartCropButtons';
                buttonsDiv.style.cssText = `
                    position: fixed;
                    bottom: 140px;
                    left: 50%;
                    transform: translateX(-50%);
                    display: flex;
                    gap: 15px;
                    z-index: 1001;
                `;
                
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = '‚úÇÔ∏è „Åì„ÅÆ„Çµ„Ç§„Ç∫„Åß„Éà„É™„Éü„É≥„Ç∞';
                confirmBtn.className = 'btn btn-success';
                confirmBtn.onclick = () => this.confirmSmartCrop();
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = '‚ùå „Ç≠„É£„É≥„Çª„É´';
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.onclick = () => this.exit10MBMode();
                
                buttonsDiv.appendChild(confirmBtn);
                buttonsDiv.appendChild(cancelBtn);
                document.body.appendChild(buttonsDiv);
                
                // Ë™¨Êòé„ÇíË°®Á§∫
                const instructions = document.getElementById('cropInstructions');
                instructions.innerHTML = 'üìè Á∑ë„ÅÆÊû†„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÁßªÂãï„ÄÅËßí„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶„Çµ„Ç§„Ç∫Ë™øÊï¥<br>9-10MB„ÅÆÁØÑÂõ≤„ÅßËá™Áî±„Å´Ë™øÊï¥„Åß„Åç„Åæ„Åô';
                instructions.classList.add('active');
            }
            
            confirmSmartCrop() {
                if (!this.smartCropArea) return;
                
                console.log(`„Çπ„Éû„Éº„Éà„ÇØ„É≠„ÉÉ„ÉóÂÆüË°å: ${this.smartCropArea.actualWidth}x${this.smartCropArea.actualHeight}`);
                
                // ÂÖÉÁîªÂÉè„Çí‰øùÂ≠ò
                this.beforeCropImage = this.currentImage;
                
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                const scaleX = this.currentImage.width / this.canvas.width;
                const scaleY = this.currentImage.height / this.canvas.height;
                
                tempCanvas.width = this.smartCropArea.actualWidth;
                tempCanvas.height = this.smartCropArea.actualHeight;
                
                tempCtx.drawImage(
                    this.currentImage,
                    this.smartCropArea.left * scaleX,
                    this.smartCropArea.top * scaleY,
                    this.smartCropArea.width * scaleX,
                    this.smartCropArea.height * scaleY,
                    0, 0,
                    tempCanvas.width,
                    tempCanvas.height
                );
                
                const img = new Image();
                img.onload = () => {
                    this.currentImage = img;
                    this.displayImage(img);
                    this.exit10MBMode();
                    this.showComparisonButton();
                    
                    const sizeInMB = (this.smartCropArea.estimatedSize / (1024 * 1024)).toFixed(2);
                    alert(`ÁîªÂÉè„ÇíÁ¥Ñ${sizeInMB}MB„Å´„Éà„É™„Éü„É≥„Ç∞„Åó„Åæ„Åó„ÅüÔºÅ`);
                };
                img.src = tempCanvas.toDataURL('image/jpeg', this.quality);
            }
            
            exit10MBMode() {
                this.is10MBMode = false;
                this.isCropMode = false;
                this.smartCropArea = null;
                
                document.getElementById('cropModeIndicator').classList.remove('active');
                document.getElementById('cropInstructions').classList.remove('active');
                
                const smartCropBox = document.getElementById('smartCropBox');
                if (smartCropBox) {
                    smartCropBox.remove();
                }
                
                const buttons = document.getElementById('smartCropButtons');
                if (buttons) {
                    buttons.remove();
                }
            }
            
            async cropTo10MB() {
                console.log('===== 10MB„Éà„É™„Éü„É≥„Ç∞Âá¶ÁêÜÈñãÂßã =====');
                const startTime = performance.now();
                
                // „Éó„É≠„Ç∞„É¨„ÇπË°®Á§∫„Çí‰ΩúÊàê
                this.showProgressIndicator('10MB„Å´ÊúÄÈÅ©Âåñ‰∏≠...');
                
                const targetSize = 10 * 1024 * 1024; // 10MB in bytes
                console.log(`ÁõÆÊ®ô„Çµ„Ç§„Ç∫: ${(targetSize / (1024 * 1024)).toFixed(2)}MB`);
                console.log(`ÁèæÂú®„ÅÆÁîªÂÉè„Çµ„Ç§„Ç∫: ${this.currentImage.width}x${this.currentImage.height}`);
                
                let scale = 1;
                let quality = this.quality;
                let attempts = 0;
                const maxAttempts = 20;
                let lastEstimatedSize = 0;
                
                console.log(`ÂàùÊúüË®≠ÂÆö - Scale: ${scale}, Quality: ${quality}`);
                
                while (attempts < maxAttempts) {
                    console.log(`\n--- Ë©¶Ë°å ${attempts + 1}/${maxAttempts} ---`);
                    
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCanvas.width = Math.round(this.currentImage.width * scale);
                    tempCanvas.height = Math.round(this.currentImage.height * scale);
                    
                    console.log(`Canvas „Çµ„Ç§„Ç∫: ${tempCanvas.width}x${tempCanvas.height}`);
                    console.log(`Scale: ${scale.toFixed(3)}, Quality: ${quality.toFixed(3)}`);
                    
                    tempCtx.drawImage(this.currentImage, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    const dataUrl = tempCanvas.toDataURL('image/jpeg', quality);
                    const base64 = dataUrl.split(',')[1];
                    const estimatedSize = base64.length * 0.75;
                    
                    console.log(`Êé®ÂÆö„Çµ„Ç§„Ç∫: ${(estimatedSize / (1024 * 1024)).toFixed(2)}MB`);
                    console.log(`ÁõÆÊ®ô„Å®„ÅÆÂ∑Æ: ${((estimatedSize - targetSize) / (1024 * 1024)).toFixed(2)}MB`);
                    console.log(`Ë™§Â∑ÆÁéá: ${(Math.abs(estimatedSize - targetSize) / targetSize * 100).toFixed(1)}%`);
                    
                    // „Éó„É≠„Ç∞„É¨„ÇπÊõ¥Êñ∞
                    this.updateProgressIndicator(
                        `ÊúÄÈÅ©Âåñ‰∏≠... (${attempts + 1}/${maxAttempts})<br>` +
                        `ÁèæÂú®: ${(estimatedSize / (1024 * 1024)).toFixed(2)}MB / ÁõÆÊ®ô: 10MB`
                    );
                    
                    if (Math.abs(estimatedSize - targetSize) < targetSize * 0.05) {
                        // 5%‰ª•ÂÜÖ„ÅÆË™§Â∑Æ„Å™„ÇâÂÆå‰∫Ü
                        console.log('‚úÖ ÁõÆÊ®ô„Çµ„Ç§„Ç∫„Å´Âà∞ÈÅîÔºÅ');
                        const img = new Image();
                        img.onload = () => {
                            this.currentImage = img;
                            this.displayImage(img);
                            const endTime = performance.now();
                            console.log(`Âá¶ÁêÜÂÆå‰∫ÜÔºÅ ÊâÄË¶ÅÊôÇÈñì: ${((endTime - startTime) / 1000).toFixed(2)}Áßí`);
                            console.log('===== 10MB„Éà„É™„Éü„É≥„Ç∞Âá¶ÁêÜÁµÇ‰∫Ü =====\n');
                            this.hideProgressIndicator();
                            alert(`ÁîªÂÉè„ÇíÁ¥Ñ10MB (${(estimatedSize / (1024 * 1024)).toFixed(2)}MB) „Å´ÊúÄÈÅ©Âåñ„Åó„Åæ„Åó„ÅüÔºÅ`);
                        };
                        img.src = dataUrl;
                        break;
                    }
                    
                    // ÂèéÊùü„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆË≠¶Âëä
                    if (attempts > 5 && Math.abs(lastEstimatedSize - estimatedSize) < 1024) {
                        console.warn('‚ö†Ô∏è „Çµ„Ç§„Ç∫„ÅåÂèéÊùü„Åó„Å™„ÅÑÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô');
                    }
                    lastEstimatedSize = estimatedSize;
                    
                    if (estimatedSize > targetSize) {
                        const oldScale = scale;
                        const oldQuality = quality;
                        
                        scale *= 0.9;
                        if (scale < 0.1) {
                            quality *= 0.9;
                            scale = 0.1;
                        }
                        
                        console.log(`üìâ „Çµ„Ç§„Ç∫„ÇíÁ∏ÆÂ∞è: Scale ${oldScale.toFixed(3)} ‚Üí ${scale.toFixed(3)}, Quality ${oldQuality.toFixed(3)} ‚Üí ${quality.toFixed(3)}`);
                    } else {
                        const oldScale = scale;
                        const oldQuality = quality;
                        
                        scale *= 1.05;
                        if (scale > 1) {
                            scale = 1;
                            quality = Math.min(quality * 1.1, 1);
                        }
                        
                        console.log(`üìà „Çµ„Ç§„Ç∫„ÇíÊã°Â§ß: Scale ${oldScale.toFixed(3)} ‚Üí ${scale.toFixed(3)}, Quality ${oldQuality.toFixed(3)} ‚Üí ${quality.toFixed(3)}`);
                    }
                    
                    attempts++;
                }
                
                if (attempts >= maxAttempts) {
                    console.error('‚ùå ÊúÄÂ§ßË©¶Ë°åÂõûÊï∞„Å´Âà∞ÈÅî„ÄÇÂá¶ÁêÜ„Çí‰∏≠Ê≠¢„Åó„Åæ„Åó„Åü„ÄÇ');
                    this.hideProgressIndicator();
                    alert('10MB„Å∏„ÅÆÊúÄÈÅ©Âåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÁîªÂÉè„ÅåÂ∞è„Åï„Åô„Åé„Çã„Åã„ÄÅÂ§ß„Åç„Åô„Åé„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ');
                }
                
                const endTime = performance.now();
                console.log(`Á∑èÂá¶ÁêÜÊôÇÈñì: ${((endTime - startTime) / 1000).toFixed(2)}Áßí`);
                console.log('===== 10MB„Éà„É™„Éü„É≥„Ç∞Âá¶ÁêÜÁµÇ‰∫Ü =====\n');
            }
            
            showProgressIndicator(message) {
                // Êó¢Â≠ò„ÅÆ„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„ÇíÂâäÈô§
                const existing = document.getElementById('progressIndicator');
                if (existing) {
                    existing.remove();
                }
                
                const indicator = document.createElement('div');
                indicator.id = 'progressIndicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 30px 40px;
                    border-radius: 15px;
                    font-size: 16px;
                    z-index: 10000;
                    text-align: center;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                `;
                indicator.innerHTML = `
                    <div style="margin-bottom: 15px;">‚è≥</div>
                    <div>${message}</div>
                `;
                document.body.appendChild(indicator);
            }
            
            updateProgressIndicator(message) {
                const indicator = document.getElementById('progressIndicator');
                if (indicator) {
                    indicator.innerHTML = `
                        <div style="margin-bottom: 15px;">‚è≥</div>
                        <div>${message}</div>
                    `;
                }
            }
            
            hideProgressIndicator() {
                const indicator = document.getElementById('progressIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            resizeCanvas() {
                const width = parseInt(document.getElementById('widthInput').value) || 100;
                const height = parseInt(document.getElementById('heightInput').value) || 100;
                
                console.log(`Resizing image to: ${width}x${height}`);
                
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = width;
                tempCanvas.height = height;
                tempCtx.drawImage(this.currentImage, 0, 0, width, height);
                
                // Êñ∞„Åó„ÅÑImage„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê„Åó„Å¶„Çµ„Ç§„Ç∫„ÇíÊ≠£„Åó„ÅèË®≠ÂÆö
                tempCanvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const img = new Image();
                    img.onload = () => {
                        this.currentImage = img;
                        this.displayImage(img);
                        URL.revokeObjectURL(url);
                    };
                    img.src = url;
                }, 'image/jpeg', this.quality);
            }
            
            updateSizeDisplay() {
                if (!this.currentImage) return;
                
                // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞
                console.log('updateSizeDisplay called');
                console.log(`Canvas size: ${this.canvas.width}x${this.canvas.height}`);
                console.log(`Image size: ${this.currentImage.width}x${this.currentImage.height}`);
                console.log(`Quality: ${this.quality}`);
                
                // ÂÆüÈöõ„ÅÆÁîªÂÉè„Çµ„Ç§„Ç∫„ÅßBlob„Çí‰ΩúÊàê
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // ÂÖÉÁîªÂÉè„ÅÆ„Çµ„Ç§„Ç∫„Çí‰ΩøÁî®
                tempCanvas.width = this.currentImage.width;
                tempCanvas.height = this.currentImage.height;
                tempCtx.drawImage(this.currentImage, 0, 0);
                
                tempCanvas.toBlob((blob) => {
                    if (!blob) {
                        console.error('Blob creation failed');
                        return;
                    }
                    
                    const sizeInBytes = blob.size;
                    const sizeInKB = sizeInBytes / 1024;
                    const sizeInMB = sizeInKB / 1024;
                    
                    console.log(`Blob size: ${sizeInBytes} bytes = ${sizeInKB.toFixed(2)} KB = ${sizeInMB.toFixed(2)} MB`);
                    
                    // „Çµ„Ç§„Ç∫Ë°®Á§∫„ÇíÊõ¥Êñ∞
                    let sizeText;
                    if (sizeInMB >= 1) {
                        sizeText = `${sizeInMB.toFixed(2)} MB`;
                    } else if (sizeInKB >= 1) {
                        sizeText = `${sizeInKB.toFixed(2)} KB`;
                    } else {
                        sizeText = `${sizeInBytes} bytes`;
                    }
                    
                    document.getElementById('currentSize').textContent = sizeText;
                    
                    // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆÊõ¥Êñ∞Ôºà10MB„ÇíÂü∫Ê∫ñÔºâ
                    const percentage = Math.min((sizeInBytes / (10 * 1024 * 1024)) * 100, 100);
                    document.getElementById('sizeProgressBar').style.width = `${percentage}%`;
                    
                    // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆËâ≤„ÇíÊõ¥Êñ∞
                    const progressBar = document.getElementById('sizeProgressBar');
                    if (sizeInMB > 10.5) {
                        progressBar.style.background = '#dc3545'; // Ëµ§
                    } else if (sizeInMB > 9.5 && sizeInMB <= 10.5) {
                        progressBar.style.background = '#28a745'; // Á∑ë
                    } else {
                        progressBar.style.background = '#ffc107'; // ÈªÑ
                    }
                    
                    // Ëß£ÂÉèÂ∫¶Ë°®Á§∫ÔºàÂÆüÈöõ„ÅÆÁîªÂÉè„Çµ„Ç§„Ç∫Ôºâ
                    document.getElementById('resolution').textContent = 
                        `${this.currentImage.width} x ${this.currentImage.height}`;
                }, 'image/jpeg', this.quality);
            }
            
            updateCropSizeDisplay() {
                if (!this.cropArea) return;
                
                const scaleX = this.currentImage.width / this.canvas.width;
                const scaleY = this.currentImage.height / this.canvas.height;
                
                const actualWidth = Math.round(this.cropArea.width * scaleX);
                const actualHeight = Math.round(this.cropArea.height * scaleY);
                
                document.getElementById('resolution').textContent = 
                    `${actualWidth} x ${actualHeight} (ÈÅ∏Êäû‰∏≠)`;
            }
            
            downloadImage() {
                this.canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `trimmed_image_${Date.now()}.jpg`;
                    a.click();
                    URL.revokeObjectURL(url);
                }, 'image/jpeg', this.quality);
            }
            
            resetImage() {
                if (this.originalImage) {
                    this.currentImage = this.originalImage;
                    this.beforeCropImage = null;
                    this.isShowingOriginal = false;
                    this.displayImage(this.originalImage);
                    this.exitCropMode();
                    
                    // ÊØîËºÉ„Éú„Çø„É≥„ÇíÂâäÈô§
                    const compareBtn = document.getElementById('compareBtn');
                    if (compareBtn) {
                        compareBtn.remove();
                    }
                }
            }
            
            selectNewImage() {
                this.hideEditor();
                this.originalImage = null;
                this.currentImage = null;
                this.cropArea = null;
                document.getElementById('fileInput').value = '';
            }
        }
        
        // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
        const trimmer = new ImageTrimmer();
    </script>
</body>
</html>